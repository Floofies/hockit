<!DOCTYPE html>
<html lang="en">

<head>
	<title>HockIt</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
	<link id="themeLink" rel="stylesheet" href="../themes/default.css">
	<script type="text/javascript">
		function getHash() {
			if (window.location.hash.length < 2) return null;
			return window.location.hash.slice(1, window.location.hash.length)
		}
		function getQueryString() {
			if (window.location.search.length === 0) return null;
			const paramsObj = {};
			Array.from(new URLSearchParams(window.location.search).entries()).forEach(pair => paramsObj[pair[0]] = pair[1]);
			return paramsObj;
		}
		function copy(str) {
			const el = document.createElement('textarea');
			el.value = str;
			document.body.appendChild(el);
			el.select();
			document.execCommand('copy');
			document.body.removeChild(el);
		};
		window.addEventListener("load", () => {
			const query = getQueryString();
			if (query === null) return;
			const config = JSON.parse(atob(query.data));
			const files = config.links.files;
			const total = config.links.total;
			const heading = document.getElementById("heading");
			const totalCounter = document.getElementById("total");
			const list = document.getElementById("list");
			const itemTempl = document.getElementById("itemTemplate").cloneNode(true);
			const delBox = document.getElementById("delBox");
			const delText = document.getElementById("delText");
			const delConfirm = document.getElementById("delConfirm");
			const yesBtn = document.getElementById("yesBtn");
			const noBtn = document.getElementById("noBtn");
			const pwBox = document.getElementById("pwBox");
			const pwForm = document.getElementById("pwForm");
			const pwFormSubmit = document.getElementById("pwFormSubmit");
			const passInput = document.getElementById("password");
			const delId = document.getElementById("delId");
			const homeBtn = document.getElementById("homeBtn");
			const listBtn = document.getElementById("listBtn");
			const listForm = document.getElementById("listForm");
			const viewListBtn = document.getElementById("viewListBtn");
			const viewGridBtn = document.getElementById("viewGridBtn");
			const viewSwapBtn = document.getElementById("viewSwapBtn");
			const viewSizeBtn = document.getElementById("viewSizeBtn");
			const pageInput = document.getElementById("page");
			const nextBtn = document.getElementById("nextPage");
			const prevBtn = document.getElementById("prevPage");
			const hash = getHash();
			if (hash !== null) {
				const pair = hash.split("/");
				var page = Number(pair[0]);
				var totalPages = Number(pair[1]);
				if (totalPages < 1) totalPages = 1;
				else totalPages = Math.ceil(totalPages);
			} else {
				var page = 0;
				var totalPages = 1;
			}
			pageInput.value = page;
			if (files.length === 1) heading.textContent = "hockit list " + files[0].hash;
			totalCounter.textContent = files.length + " of " + total + " Files, Page " + (page + 1) + " of " + totalPages;
			var newView = window.localStorage.getItem("view");
			var curView = "grid";
			function setGrid() {
				if (curView === "grid") return;
				curView = "grid";
				list.classList.remove("listView");
				list.classList.add("gridView");
				window.localStorage.setItem("view", "grid");
				viewGridBtn.classList.add("selectedBtn");
				viewListBtn.classList.remove("selectedBtn");
			}
			function setList() {
				if (curView === "list") return;
				curView = "list";
				list.classList.remove("gridView");
				list.classList.add("listView");
				window.localStorage.setItem("view", "list");
				viewListBtn.classList.add("selectedBtn");
				viewGridBtn.classList.remove("selectedBtn");
			}
			var order = "Ascending";
			function setOrder() {
				if (order === "Ascending") order = "Descending";
				else if (order === "Descending") order = "Ascending";
				viewSwapBtn.classList.toggle("flip");
				viewSwapBtn.setAttribute("title", "Sort by Age in " + order + " order");
				const nodes = Array.from(list.childNodes).sort(() => -1);
				while (list.hasChildNodes()) list.removeChild(list.lastChild);
				for (const node of nodes) list.appendChild(node);
			}
			var size = "Small";
			function setSize() {
				if (size === "Small") size = "Large";
				else if (size === "Large") size = "Small";
				const opposite = ((size === "Large") ? "Small" : "Large");
				viewSizeBtn.setAttribute("src", "/themes/image-size-select-" + opposite.toLowerCase() + ".png");
				viewSizeBtn.setAttribute("title", "Show " + opposite + " Thumbnails");
				list.classList.toggle("largeThumbs", size === "Large");
				window.setTimeout(truncate, 100);
			}
			viewListBtn.addEventListener("click", setList);
			viewGridBtn.addEventListener("click", setGrid);
			viewSwapBtn.addEventListener("click", setOrder);
			viewSizeBtn.addEventListener("click", setSize);
			if ((page + 1) < totalPages) {
				nextBtn.classList.remove("hidden");
				nextBtn.addEventListener("click", () => {
					page++;
					pageInput.value = page;
					pwForm.setAttribute("action", "/list");
					if (passInput.value.trim() !== "") pwForm.submit();
					else pwBox.classList.remove("hidden");
				});
			}
			if (page !== 0) {
				prevBtn.classList.remove("hidden");
				prevBtn.addEventListener("click", () => {
					if (page === 0) return;
					page--;
					pageInput.value = page;
					pwForm.setAttribute("action", "/list");
					if (passInput.value.trim() !== "") pwForm.submit();
					else pwBox.classList.remove("hidden");
				});
			}
			homeBtn.addEventListener("click", () => {
				location.href = "/";
			});
			listBtn.addEventListener("click", () => {
				pwForm.setAttribute("action", "/list");
				if (passInput.value.trim() !== "") pwForm.submit();
				else pwBox.classList.remove("hidden");
			});
			yesBtn.addEventListener("click", () => {
				delConfirm.classList.add("hidden");
				delBox.classList.add("hidden");
				pwBox.classList.remove("hidden");
			});
			noBtn.addEventListener("click", () => {
				delBox.classList.add("hidden");
			});
			passInput.addEventListener("input", () => {
				if (passInput.value === "") pwFormSubmit.textContent = "Cancel";
				else pwFormSubmit.textContent = "Ok";
			});
			pwFormSubmit.addEventListener("click", (e) => {
				e.preventDefault();
				const password = passInput.value;
				if (passInput.value.trim() === "") pwBox.classList.add("hidden");
				else pwForm.submit();
			});
			for (const file of files.sort(() => -1)) {
				const templ = itemTempl.cloneNode(true).content;
				const thumbLink = templ.querySelector("[name=thumbLink]");
				thumbLink.setAttribute("href", "/" + file.hash);
				thumbLink.setAttribute("title", file.name);
				const thumb = templ.querySelector("[name=thumb]");
				const listener = (e) => {
					thumb.setAttribute("src", "/themes/file-download-outline.png");
					e.target.removeEventListener("error", listener);
				};
				const errHandler = thumb.addEventListener("error", listener);
				thumb.setAttribute("src", "t-" + file.hash + "." + file.name);
				thumb.setAttribute("title", file.name);
				const link = templ.querySelector("[name=link]");
				link.setAttribute("href", "/" + file.hash);
				link.setAttribute("title", file.hash);
				link.textContent = file.hash;
				const date = templ.querySelector("[name=date]");
				const fileDate = new Date(file.date);
				const year = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(fileDate);
				const month = new Intl.DateTimeFormat('en', { month: 'short' }).format(fileDate);
				const day = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(fileDate);
				dateStr = month + " " + day + "\n" + year;
				date.textContent = dateStr;
				date.setAttribute("title", dateStr);
				const name = templ.querySelector("[name=name]");
				name.textContent = file.name;
				name.setAttribute("title", file.name);
				name.setAttribute("href", "/" + file.hash);
				const copyBtn = templ.querySelector("[name=copy]");
				copyBtn.addEventListener("click", () => {
					const url = "http://" + window.location.hostname + "/" + file.hash;
					copy(url);
					flash("Copied " + url);
				});
				const delBtn = templ.querySelector("[name=delBtn]");
				delBtn.addEventListener("click", () => {
					delText.textContent = "Delete " + file.name + "?";
					pwForm.setAttribute("action", "/delete/" + file.hash);
					delBox.classList.remove("hidden");
				});
				list.appendChild(templ);
			}
			const nodes = document.querySelectorAll("[name=name]");
			function truncate() {
				nodes.forEach(node => delete node.removeAttribute("data-tail"));
				nodes.forEach(node => {
					if (node.offsetWidth < node.scrollWidth) {
						node.dataset.tail = node.textContent.slice(node.textContent.length - 8);
					}
				});
			}
			if (newView === "list") setList();
			else truncate();
		});
	</script>
	<script type="text/javascript" src="../themes/theme.js"></script>
</head>

<body>
	<template id="itemTemplate">
		<div class="item">
			<div class="date" name="date"></div>
			<a class="thumbLink" name="thumbLink" href="">
				<img name="thumb" class="thumb" src="">
			</a>
			<a class="name" name="name"></a>
			<div class="link">
				<img class="copy" title="Copy to Clipboard" name="copy"
					src="/themes/clipboard-plus-outline.png">
				<a name="link" href=""></a>
				<img name="delBtn" title="Delete File" class="delBtn"
					src="/themes/delete-forever-outline.png">
			</div>
		</div>
	</template>
	<div class="main">
		<h1 id="heading" class="heading hlist">hockit list</h1>
		<button id="homeBtn" type="button">Upload</button>
		<button id="listBtn" type="button">List</button>
		<div class="topRow">
			<div id="controls" class="controls">
				<img id="viewGridBtn" title="View as Grid" class="controlBtn selectedBtn"
					src="/themes/view-grid.png">
				<img id="viewListBtn" title="View as List" class="controlBtn"
					src="/themes/view-agenda.png">
				<img id="viewSwapBtn" title="Sort by Age in Ascending order" class="controlBtn"
					src="/themes/chevron-down-box.png">
				<img id="viewSizeBtn" title="Show Large Thumbnails" class="controlBtn"
					src="/themes/image-size-select-large.png">
			</div>
			<div id="pageButtons" class="pageButtons">
				<div id="total" class="total">0 Files</div>
				<button class="hidden"id="prevPage">&lt;Prev</button>
				<button class="hidden" id="nextPage">Next &gt;</button>
			</div>
		</div>
		<div id="list" class="list gridView"></div>
		<div class="footer">
			<label class="themeList" for="theme">Theme:</label>
			<select name="theme" class="themeList" id="themeList">
				<option value="default" selected>Default</option>
				<option value="dark">Dark</option>
				<option value="terminal">Terminal</option>
				<option value="booru">Booru</option>
			</select>
			<h4>v2.0.0</h4>
		</div>
	</div>
	<div id="delBox" class="box hidden">
		<div id="delText" class="delText"></div>
		<div id="delConfirm">
			<button id="yesBtn" value="true">Yes</button> <button id="noBtn" value="false">No</button>
		</div>
	</div>
	<div id="pwBox" class="box hidden">
		<form id="pwForm" name="pwForm" method="post" enctype="multipart/form-data" action="">
			Password Required
			<input id="password" type="password" name="password" autocomplete="current-password" value="">
			<input id="page" class="hidden" type="number" name="page" value="0">
			<button id="pwFormSubmit">Cancel</button>
		</form>
	</div>
</body>

</html>